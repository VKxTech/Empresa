<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VKX Payment | <%- invoice.description %></title>
    <link rel="stylesheet" href="/css/output.css">
</head>
<body class="bg-dark text-white flex items-center justify-center min-h-screen p-6">
    <div class="max-w-md w-full bg-dark-surface border border-white/10 rounded-[2.5rem] p-12 shadow-2xl relative overflow-hidden">
        <!-- Glow Effect -->
        <div class="absolute -top-24 -right-24 w-64 h-64 bg-primary/20 rounded-full blur-[100px]"></div>

        <div class="text-center relative z-10">
            <h1 class="text-xl font-outfit font-black text-gradient mb-12">VKX TECHNOLOGIES</h1>
            
            <div class="mb-12">
                <p class="text-white/40 text-xs font-bold uppercase tracking-widest mb-2">Valor Solicitado</p>
                <p class="text-5xl font-black">R$ <%= invoice.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></p>
            </div>

            <div class="bg-white/5 rounded-3xl p-6 mb-12 text-left border border-white/5">
                <p class="text-[10px] font-bold text-primary uppercase tracking-widest mb-4">Detalhes da Transação</p>
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-white/40">Fatura para:</span>
                        <span class="font-medium"><%= invoice.lead.name %></span>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-white/40">Descrição:</span>
                        <span class="font-medium"><%= invoice.description %></span>
                    </div>
                </div>
            </div>

            <% if (invoice.status === 'paid') { %>
                <div class="bg-green-500/10 border border-green-500/20 text-green-500 p-6 rounded-3xl font-bold">
                    PAGAMENTO CONFIRMADO
                </div>
            <% } else { %>
                <div id="payment-area">
                    <button onclick="initPayment()" id="pay-btn" class="w-full btn-primary py-5 text-xl">
                        Pagar Agora
                    </button>
                    
                    <div id="loading" class="hidden py-8">
                        <div class="animate-spin w-12 h-12 border-4 border-primary border-t-transparent rounded-full mx-auto"></div>
                        <p class="text-sm mt-4 text-white/40">Gerando cobrança segura...</p>
                    </div>

                    <div id="pix-area" class="hidden space-y-8 animate-in fade-in zoom-in duration-500">
                        <div class="bg-white p-4 rounded-3xl inline-block shadow-lg">
                            <img id="pix-qr" src="" class="w-48 h-48" alt="PIX QR Code">
                        </div>
                        <div>
                            <p class="text-xs text-white/40 mb-4">Ou copie e cole o código abaixo:</p>
                            <input type="text" id="pix-copy" readonly class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none">
                            <button onclick="copyPix()" class="mt-4 text-primary text-sm font-bold">Copiar Código PIX</button>
                        </div>
                    </div>
                </div>
            <% } %>

            <p class="text-[10px] text-white/20 mt-12 uppercase tracking-widest">Powered by VKX Secure Payments</p>
        </div>
    </div>

    <script>
        async function initPayment() {
            const btn = document.getElementById('pay-btn');
            const loading = document.getElementById('loading');
            const pixArea = document.getElementById('pix-area');
            const pixQr = document.getElementById('pix-qr');
            const pixCopy = document.getElementById('pix-copy');

            btn.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const res = await fetch('/api/pay/<%= invoice.token %>/init', { method: 'POST' });
                const data = await res.json();

                if (data.pixCopyPaste) {
                    loading.classList.add('hidden');
                    pixArea.classList.remove('hidden');
                    pixCopy.value = data.pixCopyPaste;
                    // In a real app, generate QR from copy paste or use data.pixQr
                    pixQr.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data.pixCopyPaste)}`;
                } else if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                }
            } catch (err) {
                alert('Erro ao processar pagamento. Tente novamente.');
                btn.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        function copyPix() {
            const copyText = document.getElementById('pix-copy');
            copyText.select();
            document.execCommand('copy');
            alert('Código PIX copiado!');
        }
    </script>
</body>
</html>
